# 📌 Endpoint: `PATCH /api/accounts/v1/profile/update-email/confirm/`

### 🎯 کاربرد:

این API برای تأیید لینک و تکمیل فرآیند تغییر ایمیل کاربر استفاده می‌شود. کاربر پس از دریافت لینک تأیید در ایمیل جدید، باید توکن و ایمیل جدید را ارسال کند.

> این endpoint **مرحله دوم** در فرآیند تغییر ایمیل است و نیاز به **احراز هویت** دارد.

---

## 📋 شرایط استفاده

* ✅ فقط کاربران **(authenticated)** مجاز به استفاده هستند.
* ✅ شناسه باید **ایمیل معتبر** باشد (نه شماره تلفن).
* ✅ ایمیل جدید باید **منحصر به فرد** باشد (قبلاً ثبت نشده).
* ✅ توکن تأیید باید **معتبر و منقضی نشده** باشد.
* 🚦 این endpoint تحت **محدودیت نرخ (Rate Limiting)** است.

---

## 🔐 سطح دسترسی

| شرط                          | وضعیت                        |
| ---------------------------- | ---------------------------- |
| نیاز به لاگین؟               | ✅ بله (کاربران احراز هویت شده) |
| محدودیت نرخ (Throttle) فعال؟ | ✅ بله                        |

---

## 📨 درخواست

### ➤ Method: `PATCH`

### ➤ URL: `/api/accounts/v1/profile/update-email/confirm/`

---

### Headers

| کلید          | مقدار              |
| ------------- | ------------------ |
| Content-Type  | `application/json` |
| Authorization | `Bearer YOUR_TOKEN` |

---

### Body (JSON)

```json
{
  "identity": "newemail@example.com",
  "token": "abc123def456ghi789"
}
```

| فیلد       | نوع    | الزامی؟ | توضیح                                        |
| ---------- | ------ | ------- | -------------------------------------------- |
| `identity` | string | ✅       | آدرس ایمیل جدید که باید تأیید شود            |
| `token`    | string | ✅       | توکن تأیید دریافت شده از لینک ایمیل         |

---

## 🧪 نمونه‌های معتبر

#### ✅ تأیید ایمیل جدید:

```json
{ 
  "identity": "user.new@example.com",
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9"
}
```

---

## ✅ پاسخ موفق

### ✔️ Status Code: `200 OK`

```json
{
  "detail": "ایمیل با موفقیت تغیر کرد."
}
```

---

## ❌ پاسخ‌های خطا

| کد وضعیت | توضیح                                | نمونه پاسخ                                                                                                      |
| -------- | ------------------------------------ | --------------------------------------------------------------------------------------------------------------- |
| `400`    | خطاهای اعتبارسنجی توکن یا ایمیل     | 👇 نمونه‌ها در ادامه                                                                                            |
| `401`    | کاربر احراز هویت نشده               | `{ "detail": "Authentication credentials were not provided." }`                                                 |
| `429`    | عبور از حد مجاز تعداد درخواست        | `{ "detail": "شما بیش از حد مجاز درخواست ارسال کرده‌اید.", "available_in_seconds": 42 }`                      |
| `500`    | خطای داخلی سرور یا مشکل غیرمنتظره    | `{ "detail": "خطای ناشناخته‌ای رخ داده است. لطفاً دوباره تلاش کنید." }`                                         |

---

### 📉 نمونه پاسخ 400

#### ❗ عدم ارسال ایمیل:

```json
{
  "identity": ["وارد کردن ایمیل یا شماره تلفن الزامی است."]
}
```

#### ❗ ایمیل خالی:

```json
{
  "identity": ["لطفاً ایمیل یا شماره تلفن را وارد کنید."]
}
```

#### ❗ ایمیل نامعتبر:

```json
{
  "identity": ["ایمیل نامعتبر است. لطفاً یک ایمیل معتبر مانند example@example.com وارد کنید."]
}
```

#### ❗ شماره تلفن به جای ایمیل:

```json
{
  "identity": ["برای تایید لینک ایمیل، لطفاً یک آدرس ایمیل معتبر وارد کنید."]
}
```

#### ❗ ایمیل تکراری:

```json
{
  "identity": ["این ایمیل قبلاً ثبت شده است."]
}
```

#### ❗ عدم ارسال توکن:

```json
{
  "token": ["توکن تایید لینک الزامی است."]
}
```

#### ❗ توکن خالی:

```json
{
  "token": ["توکن تایید لینک نمی‌تواند خالی باشد."]
}
```

#### ❗ توکن نامعتبر:

```json
{
  "token": ["توکن نامعتبر است."]
}
```

#### ❗ توکن منقضی شده:

```json
{
  "token": ["توکن منقضی شده است. لطفاً مجدداً درخواست دهید."]
}
```

---
