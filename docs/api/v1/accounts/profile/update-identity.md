# 📌 Endpoint: `PATCH /api/accounts/v1/profile/update-identity/`

### 🎯 کاربرد:

این API برای شروع فرآیند تغییر ایمیل یا شماره تلفن کاربر استفاده می‌شود. بسته به نوع شناسه ارسالی، یک لینک تأیید (برای ایمیل) یا کد OTP (برای شماره تلفن) ارسال خواهد شد.

> این endpoint نیاز به **احراز هویت** دارد و **اولین مرحله** در فرآیند تغییر اطلاعات تماس کاربر است.

---

## 📋 شرایط استفاده

* ✅ فقط کاربران **(authenticated)** مجاز به استفاده هستند.
* ✅ شناسه جدید باید **منحصر به فرد** باشد (قبلاً ثبت نشده).
* ⏱ پس از ارسال موفق، تا **۲ دقیقه** برای همان شناسه امکان ارسال مجدد وجود ندارد.
* 🚦 این endpoint تحت **محدودیت نرخ (Rate Limiting)** است.

---

## 🔐 سطح دسترسی

| شرط                          | وضعیت                        |
| ---------------------------- | ---------------------------- |
| نیاز به لاگین؟               | ✅ بله (کاربران احراز هویت شده) |
| محدودیت نرخ (Throttle) فعال؟ | ✅ بله                        |

---

## 📨 درخواست

### ➤ Method: `PATCH`

### ➤ URL: `/api/accounts/v1/profile/update-identity/`

---

### Headers

| کلید          | مقدار              |
| ------------- | ------------------ |
| Content-Type  | `application/json` |
| Authorization | `Bearer YOUR_TOKEN` |

---

### Body (JSON)

```json
{
  "identity": "newemail@example.com"
}
```

| فیلد       | نوع    | الزامی؟ | توضیح                                        |
| ---------- | ------ | ------- | -------------------------------------------- |
| `identity` | string | ✅       | ایمیل یا شماره موبایل ایرانی (`09xxxxxxxxx`) |

---

## 🧪 نمونه‌های معتبر

#### ✅ درخواست تغییر ایمیل:

```json
{ 
  "identity": "newemail@example.com" 
}
```

#### ✅ درخواست تغییر شماره تلفن:

```json
{ 
  "identity": "09987654321" 
}
```

---

## ✅ پاسخ موفق

### ✔️ Status Code: `200 OK`

#### 📧 برای ایمیل:

```json
{
  "detail": "لینک تایید به ایمیل ارسال شد",
  "next_url": "/api/v1/accounts/profile/update-email/confirm/",
  "purpose": "update_email"
}
```

#### 📱 برای شماره تلفن:

```json
{
  "detail": "کد تایید به شماره تلفن ارسال شد",
  "next_url": "/api/v1/accounts/profile/update-phone/verify/",
  "purpose": "update_phone"
}
```

| فیلد       | توضیح                                                  |
| ---------- | ------------------------------------------------------ |
| `detail`   | پیام موفقیت‌آمیز ارسال لینک یا کد                      |
| `next_url` | مسیر مرحله بعد که کلاینت باید کاربر را به آن هدایت کند |
| `purpose`  | هدف عملیات (`update_email` یا `update_phone`)          |

---

## ❌ پاسخ‌های خطا

| کد وضعیت | توضیح                                | نمونه پاسخ                                                                                                      |
| -------- | ------------------------------------ | --------------------------------------------------------------------------------------------------------------- |
| `400`    | خطاهای اعتبارسنجی شناسه             | 👇 نمونه‌ها در ادامه                                                                                            |
| `401`    | کاربر احراز هویت نشده               | `{ "detail": "Authentication credentials were not provided." }`                                                 |
| `429`    | عبور از حد مجاز تعداد درخواست        | `{ "detail": "شما بیش از حد مجاز درخواست ارسال کرده‌اید.", "available_in_seconds": 42 }`                      |
| `500`    | خطای داخلی سرور یا مشکل غیرمنتظره    | `{ "detail": "خطای ناشناخته‌ای رخ داده است. لطفاً دوباره تلاش کنید." }`                                         |

---

### 📉 نمونه پاسخ 400

#### ❗ عدم ارسال شناسه:

```json
{
  "identity": ["وارد کردن ایمیل یا شماره تلفن الزامی است."]
}
```

#### ❗ شناسه خالی:

```json
{
  "identity": ["لطفاً ایمیل یا شماره تلفن را وارد کنید."]
}
```

#### ❗ ایمیل نامعتبر:

```json
{
  "identity": ["ایمیل نامعتبر است. لطفاً یک ایمیل معتبر مانند example@example.com وارد کنید."]
}
```

#### ❗ شماره موبایل نامعتبر:

```json
{
  "identity": ["ورودی نامعتبر است. لطفاً یک ایمیل یا شماره تلفن معتبر وارد کنید."]
}
```

#### ❗ شناسه تکراری:

```json
{
  "identity": ["این ایمیل قبلاً ثبت شده است."]
}
```

---
